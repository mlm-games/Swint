name: Desktop Releases

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag (e.g., 0.9.2)'
        required: true
        type: string
      mark_prerelease:
        description: "Mark as prerelease"
        required: true
        default: false
        type: boolean

permissions:
  contents: write
  actions: write

concurrency:
  group: desktop-release-${{ inputs.version_tag }}
  cancel-in-progress: false

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  build-linux:
    strategy:
      matrix:
        arch: [x86_64, aarch64]
    runs-on: ${{ matrix.arch == 'aarch64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ inputs.version_tag }}  # Checkout the tag

      - uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: gradle

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust JNI (host)
        run: cargo build --release --manifest-path rust/Cargo.toml

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install AppImage tools
        run: |
          if [ "${{ matrix.arch }}" = "aarch64" ]; then
            APPIMAGETOOL_URL="https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage"
          else
            APPIMAGETOOL_URL="https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          fi
          wget "$APPIMAGETOOL_URL" -O appimagetool.AppImage
          chmod +x appimagetool.AppImage
          ./appimagetool.AppImage --appimage-extract
          sudo mv squashfs-root /opt/appimagetool
          sudo ln -s /opt/appimagetool/AppRun /usr/local/bin/appimagetool

      - name: Generate UniFFI (JVM) and package desktop
        run: |
          ./gradlew :composeApp:genUniFFIJvm :composeApp:packageDistributionForCurrentOS --no-daemon

      - name: Build AppImage
        run: |
          APPDIR=$(find composeApp/build/compose/binaries/main/app -type d -name "Mages" | head -n 1)
          if [ -d "$APPDIR" ]; then
            mkdir -p dist
            
            cat > "$APPDIR/mages.desktop" <<EOF
          [Desktop Entry]
          Name=Mages
          Comment=Mages matrix client (desktop)
          MimeType=x-scheme-handler/matrix;
          Exec=Mages %u
          Icon=mages
          Terminal=false
          Type=Application
          Categories=Network;InstantMessaging;
          EOF
            
            cat > "$APPDIR/AppRun" <<'EOF'
          #!/bin/sh
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/lib:${LD_LIBRARY_PATH}"
          cd "${HERE}"
          exec "${HERE}/bin/Mages" "$@"
          EOF
            chmod +x "$APPDIR/AppRun"
            
            ln -sf lib/Mages.png "$APPDIR/mages.png"
            ln -sf lib/Mages.png "$APPDIR/.DirIcon"
            
            ARCH=${{ matrix.arch }} appimagetool "$APPDIR" "dist/mages-${{ inputs.version_tag }}-${{ matrix.arch }}.AppImage"
          fi

      - name: Collect desktop artifacts
        run: |
          mkdir -p dist
          find composeApp/build/compose/binaries/main -type f \( -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) -exec cp {} dist/ \;
          ls -la dist

      - name: Upload artifacts (CI)
        uses: actions/upload-artifact@v4
        with:
          name: linux-desktop-${{ matrix.arch }}
          path: dist/*

  release:
    needs: build-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: linux-desktop-*
          merge-multiple: true
          path: dist

      - name: Create / Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version_tag }}
          name: ${{ inputs.version_tag }}
          prerelease: ${{ inputs.mark_prerelease }}
          files: dist/*

      - name: Dispatch aur-upload.yml
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'aur-upload.yml',
              ref: 'main',
              inputs: {
                version_name: '${{ inputs.version_tag }}'
              }
            });
            core.info('Triggered AUR upload for ${{ inputs.version_tag }}');
